# Progress Log - Tinta Academy

This file tracks progress across Ralph sessions. Each entry documents what was implemented, technical decisions, and suggestions for next steps.

---

## 2026-01-06 - Initial Setup

Created Ralph Wiggum infrastructure:
- plans/ralph-once.sh - Human-in-the-loop script
- plans/AGENT.md - Build/test instructions
- plans/progress.txt - This file
- plans/prd/02-landing.json - Milestone 2 PRD

Foundation (Milestone 1) was already implemented:
- NextAuth with OTP login
- App shells for all roles (public, student, educator, admin)
- Basic Prisma schema (User, Student, Educator, OtpToken)
- Routing structure with role-based protection

Next: Start implementing Milestone 2 - Landing & Catalog

---

## 2026-01-06 - Database Schema & API Foundation

**Completed (PRD items 2.01-2.09):**
- Added Course, Tag, and NewsletterSubscription models to Prisma schema
- Created CourseType, CourseModality, and CourseStatus enums  
- Implemented many-to-many relationship between Course and Tag
- Added wsetLevel field for WSET courses
- Enhanced seed script with 3 educators, 6 tags, and 6 sample courses
- Created API routes: /api/courses (with filtering), /api/tags, /api/newsletter

**Technical Notes:**
- Used Prisma migrations instead of db push for better version control
- API routes support query parameters for filtering courses by modality, type, tagIds
- Courses are automatically separated into upcoming vs past based on startDate and status
- Newsletter API uses Zod validation and handles duplicate emails gracefully

**Next Priority:** UI components (CourseCard, CourseCatalog, Hero, Footer)

---

## 2026-01-06 - API Routes Refactor to Server Actions

**Completed (PRD item 2.09b):**
- Replaced API routes (/api/courses, /api/tags, /api/newsletter) with service layer architecture
- Created course-service.ts with getCourses, getUpcomingCourses, getPastCourses functions
- Created tag-service.ts with getTags function  
- Created newsletter-service.ts with subscribe function
- Added subscribeToNewsletter server action in src/app/(public)/actions.ts
- Removed API route files and cleaned up empty directories

**Technical Notes:**
- Services use proper Prisma types (CourseWhereInput, CourseModality, CourseType enums)
- Server action includes Zod validation for email input
- Course filtering logic preserved with proper TypeScript typing
- Architecture now follows Next.js App Router patterns: RSC → Services → Prisma

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** UI components implementation (CourseCard, CourseCatalog, Hero, Footer)

---

## 2026-01-06 - Landing UI Components Implementation

**Completed (PRD item 2.10):**
- Created src/types/landing.ts - adapted types from product-plan to work with Prisma Course model
- Implemented all landing components in src/components/landing/:
  - CourseCard.tsx - with Next.js Image optimization and proper Prisma type integration
  - CourseCatalog.tsx - course filtering and catalog display
  - Hero.tsx - cinematic hero section with background image
  - Header.tsx - responsive navigation header
  - Footer.tsx - full institutional footer with newsletter subscription
  - LandingCatalogo.tsx - main landing page component orchestrating all sections
- Created index.ts barrel export for clean imports
- Fixed all ESLint warnings (Next.js Image usage, unused variables)

**Technical Notes:**
- Used Next.js Image component for optimized loading instead of regular img tags
- Adapted original product-plan types to match Prisma model structure (Date types, relation structure)
- Course cards display educator info from embedded relation, not separate lookup
- Removed unused educator parameter passing through component tree
- All components are client components due to React hooks usage ('use client' directive)

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Implement landing page with real data from services (PRD 2.11)

---

## 2026-01-06 - Landing Page Implementation

**Completed (PRD item 2.11):**
- Implemented landing page with real data from services in src/app/(public)/page.tsx
- Added data transformation functions to convert Prisma types to landing page component types
- Configured hero content, footer links, and contact information for the landing page
- Integrated getUpcomingCourses, getPastCourses from course-service
- Integrated getTags from tag-service
- Transformed Prisma Course model data to match expected landing page types
- Set up LandingCatalogo component with real course and tag data

**Technical Notes:**
- Created transformation functions (transformCourse, transformTag) to bridge Prisma nullable fields with component non-nullable requirements
- Landing page now displays actual seeded courses and tags from database
- Hero section configured with wine education messaging
- Footer configured with realistic institutional links and contact information
- Placeholder handlers added for future features (navigation, subscriptions, course details)

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Wire landing page interactions (filters, scroll, navigation) - PRD 2.12

---

## 2026-01-06 - v3 Database Migration

**Completed (PRD item 2.11b):**
- Created migration scripts in scripts/migration/:
  - migrate-educators.ts - Migrates educators from v3 to v4 (creates User + Educator)
  - migrate-courses.ts - Migrates courses with type/status mapping
- Added V3_DATABASE_URL to .env.local
- Successfully migrated:
  - 1 educator (Gabi Zimmer)
  - 4 courses (WSET Nivel 1, Taller top, Cata top, Curso Test)
  - 1 course skipped (already existed from seed)

**Technical Notes:**
- Used `pg` library directly instead of Prisma adapter (Neon serverless adapter requires WebSocket)
- Scripts use DIRECT_DATABASE_URL to bypass connection pooler for better reliability
- Type mapping: WSET_NIVEL_X → type=wset + wsetLevel=X
- Status mapping: Anunciado→announced, Inscribiendo→enrolling, Finalizado→finished
- Default modality 'presencial' (v3 doesn't have this field)
- Dates: classDates[0]→startDate, examDate or last classDate→endDate
- Duration string: "{totalDuration} horas"
- Educator mapping saved to educator-mapping.json for course migration dependency

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Wire landing page interactions (filters, scroll, navigation) - PRD 2.12

---

## 2026-01-06 - Landing Page Interactions

**Completed (PRD item 2.12):**
- Created LandingClientWrapper component to handle client-side interactions
- Implemented URL search params support for filtering (?modality=online&type=wset&tagIds=id1,id2)
- Wired onFilter callback to update URL params when user changes filters
- onHeroCTA already scrolls to catalog section (implemented in LandingCatalogo)
- onNavigate callback wired to use Next.js router for navigation
- onViewCourse callback navigates to /cursos/[slug]
- Added Suspense boundary with loading fallback for the landing page

**Technical Notes:**
- Used useMemo for memoizing currentFilters from searchParams to avoid unnecessary re-renders
- Used useMemo for filtered courses arrays (filteredUpcoming, filteredPast)
- Refactored page.tsx to separate data fetching (LandingData async component) from rendering
- LandingClientWrapper reads filters from URL and applies them client-side
- CourseCatalog now accepts onFilter callback and calls updateFilters for all filter changes
- Added id="catalog" to catalog section for potential direct linking

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Implement newsletter subscription flow - PRD 2.13

---

## 2026-01-06 - Newsletter Subscription Flow

**Completed (PRD item 2.13):**
- Wired onSubscribe callback in LandingClientWrapper to call subscribeToNewsletter server action
- Updated Footer component to support async onSubscribe with loading state
- Added loading spinner and disabled state during submission
- Integrated sonner toasts for success/error feedback
- Updated LandingCatalogoProps type to reflect async onSubscribe signature

**Technical Notes:**
- Footer now shows a loading spinner and disables input during submission
- Success toast: "¡Gracias por suscribirte!" with description about future updates
- Error toast: "Error al suscribirse" with specific error message from server action
- The existing subscribed state still shows the inline success message after successful subscription
- Type signature changed from `(email: string) => void` to `(email: string) => Promise<{ success: boolean; error?: string }>`

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Implement full course detail page with modern design - PRD 2.14

---

## 2026-01-06 - Course Detail Page

**Completed (PRD item 2.14):**
- Added getCourseBySlug function to course-service.ts with educator and tags relations
- Created src/app/(public)/cursos/[slug]/page.tsx as RSC with generateMetadata for SEO
- Created src/components/course-detail/CourseDetailPage.tsx with all required sections
- Extracted footer config to src/config/footer.ts for reuse across pages
- Shared Footer component between landing and course detail pages

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Polish landing page (empty states, responsive, loading) - PRD 2.15

---

## 2026-01-06 - Landing Page Polish

**Completed (PRD item 2.15):**
- Improved empty states in CourseCatalog:
  - "No hay cursos programados" when upcomingCourses is empty (with wine emoji)
  - "No se encontraron cursos" when filters return no results with prominent "Limpiar filtros" button
- Past courses section already hides when empty (was already implemented)
- Created CourseCatalogSkeleton component for loading states:
  - Header skeleton with animated pulse
  - 4 course card skeletons with image, title, date, description, tags, and footer placeholders
- Added Suspense boundary in landing page with LandingFallback component:
  - Hero skeleton (animated pulse)
  - CourseCatalogSkeleton for course grid

**Technical Notes:**
- Skeleton uses Tailwind animate-pulse for smooth loading animation
- Empty states use visual hierarchy: emoji icon, bold title, muted description
- "Limpiar filtros" button uses primary color and is prominently displayed
- Suspense boundary wraps LandingClientWrapper to show fallback during data loading

**Verification:** All checks pass (typecheck, lint, build)

**MILESTONE 2 COMPLETE** - All PRD items pass. Next milestone: 03-enrollment or 04-educator

---

## 2026-01-08 - Educator Milestone Start (4.01)

**Completed (PRD item 4.01):**
- Added 'draft' status to CourseStatus enum in Prisma schema
- Created migration: 20260108125218_add_draft_status
- Updated src/types/landing.ts to include 'draft' in Course status type

**Technical Notes:**
- Draft status placed before 'announced' in enum order (represents workflow: draft → announced → enrolling → ...)
- Draft courses will be used by educators to create courses before publishing
- Updated landing.ts type to match Prisma enum (required for type compatibility)
- Pre-existing lint errors in testimonials-section.tsx and user-dropdown.tsx not addressed (unrelated to this change)

**Verification:** typecheck ✓, build ✓ (lint has pre-existing errors unrelated to this change)

**Next Priority:** Create Enrollment model (4.02)

---

## 2026-01-08 - Enrollment Model (4.02)

**Completed (PRD item 4.02):**
- Created Enrollment model in Prisma schema with all required fields
- Created EnrollmentStatus enum: pending, confirmed, cancelled
- Added enrollments relation to Student model
- Added enrollments relation to Course model
- Added @@unique([studentId, courseId]) constraint to prevent duplicate enrollments
- Created migration: 20260108131146_add_enrollment

**Technical Notes:**
- Enrollment has onDelete: Cascade for both student and course relations
- Default status is 'pending' (new enrollments start as pending)
- enrolledAt defaults to now() for automatic timestamp on creation
- Indexes on studentId, courseId, and status for query performance

**Verification:** typecheck ✓

**Next Priority:** Migrate students from v3 database (4.02b)

---

## 2026-01-08 - Student Migration (4.02b)

**Completed (PRD item 4.02b):**
- Created scripts/migration/migrate-students.ts
- Migrated 226 students from v3 to v4 database
- Saved mapping to student-mapping.json for enrollment migration

**Technical Notes:**
- v3 Student model has email directly on Student (not on User like originally assumed)
- Script creates User with role=student + Student record for each v3 student
- Uses transaction for atomicity (User + Student created together)
- Handles duplicates by skipping if email already exists
- Maps all fields: firstName, lastName, dateOfBirth, phone, address, city, zip, country

**Verification:** typecheck ✓

**Next Priority:** Migrate enrollments from v3 Orders (4.02c)

---

## 2026-01-08 - Enrollment Migration (4.02c)

**Completed (PRD item 4.02c):**
- Created scripts/migration/migrate-enrollments.ts
- Migrated 248 enrollments from v3 Orders to v4 Enrollments
- Updated enrolledCount for 10 courses based on confirmed enrollments

**Technical Notes:**
- Course mappings built dynamically by querying both databases by slug (no separate mapping file needed)
- Status mapping: Paid → confirmed, Created/Pending/PaymentSent → pending, Rejected/Refunded/Cancelled → cancelled
- Handles duplicates (same student+course) by keeping confirmed status or most recent enrollment
- Uses Order.createdAt as enrolledAt timestamp
- Script automatically updates Course.enrolledCount based on confirmed enrollment count

**Verification:** typecheck ✓, lint ✓ (pre-existing errors only), build ✓

**Next Priority:** Create educator-service for dashboard metrics (4.03)

---

## 2026-01-08 - Educator Service (4.03)

**Completed (PRD item 4.03):**
- Created src/services/educator-service.ts with:
  - getEducatorByUserId(userId) - fetches educator with user relation
  - getEducatorById(educatorId) - fetches educator by ID
  - getEducatorDashboardMetrics(educatorId) - returns dashboard metrics

**Dashboard Metrics returned:**
- totalCourses: count of all educator courses
- publishedCourses: count of courses where status != 'draft'
- totalEnrollments: sum of enrolledCount across all courses
- upcomingCourses: array of courses with startDate > now and status in [announced, enrolling]

**Also fixed pre-existing lint errors:**
- testimonials-section.tsx: escaped quotes with &ldquo;/&rdquo;
- user-dropdown.tsx & user-menu.tsx: added eslint-disable for SSR hydration pattern
- migrate-all.ts: removed unused error variable in catch block

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Extend course-service for educator operations (4.04)

---

## 2026-01-08 - Course Service Educator Operations (4.04)

**Completed (PRD item 4.04):**
- Extended src/services/course-service.ts with educator-specific operations:
  - getEducatorCourses(educatorId, filters?) - fetches courses with status/type/modality filters
  - getCourseById(id) - fetches single course with relations
  - createCourse(data) - creates new presencial course with 'draft' status
  - updateCourse(id, data) - updates course fields selectively
  - publishCourse(id) - changes status from 'draft' to 'announced'
  - unpublishCourse(id) - changes status back to 'draft'
  - deleteCourse(id) - hard delete only if no enrollments

**Technical Notes:**
- CreateCourseInput and UpdateCourseInput interfaces exported for use in server actions
- getEducatorCourses includes enrollment count via _count relation
- updateCourse uses conditional spread to only update provided fields
- deleteCourse checks enrollment count and throws descriptive error if course has students
- New courses default to modality='presencial' (online support planned for later)
- Courses ordered by status (drafts first) then by startDate descending

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create enrollment-service for managing course enrollments (4.05)

---

## 2026-01-08 - Enrollment Service (4.05)

**Completed (PRD item 4.05):**
- Created src/services/enrollment-service.ts with all enrollment operations:
  - getEnrollmentsByCourse(courseId) - returns enrollments with student + user data
  - getEnrollmentsByStudent(studentId) - returns enrollments with course + educator data
  - getEnrollmentById(id) - fetches single enrollment with relations
  - createEnrollment(studentId, courseId) - creates new pending enrollment
  - updateEnrollmentStatus(id, status) - updates status with course count adjustment
  - cancelEnrollment(id) - convenience wrapper for cancellation
  - confirmEnrollment(id) - convenience wrapper for confirmation
  - getCourseEnrollmentStats(courseId) - returns counts by status

**Technical Notes:**
- createEnrollment checks for existing enrollment and course capacity before creating
- updateEnrollmentStatus uses transaction to atomically update enrollment and course.enrolledCount
- Course enrolledCount increments when status changes TO 'confirmed', decrements when FROM 'confirmed'
- All queries include relevant relations (student.user for email/name, course.educator for course queries)
- Error messages in Spanish for user-facing errors

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create server actions for educator course management (4.06)

---

## 2026-01-08 - Educator Server Actions (4.06)

**Completed (PRD item 4.06):**
- Created src/app/educator/actions.ts with all course management actions:
  - createCourseAction(formData) - validates with Zod, creates course as draft
  - updateCourseAction(courseId, formData) - validates and updates course fields
  - publishCourseAction(courseId) - changes status from 'draft' to 'announced'
  - unpublishCourseAction(courseId) - changes status back to 'draft'
  - deleteCourseAction(courseId) - deletes course (if no enrollments)

**Technical Notes:**
- All actions verify authentication (session required) and authorization (role=educator)
- All actions verify course ownership before mutation
- Zod schemas validate course data with Spanish error messages
- Uses explicit TypeScript return types for helper functions to ensure type narrowing
- revalidatePath called for /educator/courses, /educator, and / (landing) after mutations
- ActionResult generic type for consistent success/error responses

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create educator dashboard page with metrics (4.07)

---

## 2026-01-08 - Superadmin Course Access (4.06b)

**Completed (PRD item 4.06b):**
- Updated getAuthenticatedEducator() in src/app/educator/actions.ts
- Changed role check from `role !== 'educator'` to `role !== 'educator' && role !== 'superadmin'`
- Superadmins can now create and manage their own courses via educator panel

**Technical Notes:**
- This aligns actions.ts with middleware (proxy.ts) and layout.tsx which already allowed superadmin access
- Superadmin still needs an Educator record to associate courses (can be created via Prisma Studio or migration)
- No schema changes required - Prisma already supports User with any role having an Educator record
- Single line change with maximum impact

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create educator dashboard page with metrics (4.07)

---

## 2026-01-08 - Educator Dashboard Page (4.07)

**Completed (PRD item 4.07):**
- Updated src/app/educator/page.tsx as RSC with auth + educator data fetching
- Created src/components/educator/EducatorDashboard.tsx with:
  - Welcome message displaying educator name
  - 4 MetricCard components: Total Cursos, Cursos Publicados, Total Inscripciones, Próximos Cursos
  - Quick action buttons: Crear Curso, Ver Cursos, Ver Estudiantes (with icons)
  - List of upcoming courses (max 3) with enrollment stats and links
  - Empty state for educators with no courses
- Created src/components/educator/index.ts barrel export

**Technical Notes:**
- Page is a Server Component that fetches data before rendering
- Uses getEducatorByUserId to find educator record from session.user.id
- Uses getEducatorDashboardMetrics to get all dashboard data in single query
- EducatorDashboard is 'use client' to support client-side interactions (Link/Button)
- MetricCard is an internal component for consistent card styling
- Uses shadcn/ui Card and Button components
- Uses lucide-react icons (BookOpen, Users, Calendar, Plus, List, GraduationCap)
- Handles edge cases: no session (redirect to login), no educator record (redirect home)

**Additional fixes:**
- Added p-6 lg:p-8 padding to AppShell main content area (centralized for all authenticated pages)
- Fixed Next.js Image warnings across the app:
  - Logo component: added sizes="144px"
  - Header.tsx: added style={{ width: 'auto', height: 'auto' }} to maintain aspect ratio
  - Footer.tsx: added sizes="192px" to logo Image with fill
  - wset-section.tsx: added sizes="(max-width: 1024px) 100vw, 50vw" to WSET.jpg

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create educator course list page with filters (4.08)

---

## 2026-01-08 - Educator Course List Page (4.08 + 4.10)

**Completed (PRD items 4.08 and 4.10):**
- Updated src/app/educator/courses/page.tsx as RSC with auth + educator data fetching
- Created src/components/educator/CourseList.tsx with:
  - Search input for filtering by title/description
  - Expandable filter panel (same style as landing CourseCatalog)
  - Filter bar: status (Todos, Borrador, Publicado, Finalizado) and type (Todos, WSET, Taller, Cata, Curso)
  - URL query params support (?status=draft&type=wset)
  - Empty states for no courses and no filter results (matching landing style)
  - "Nuevo Curso" button
  - Publish/Unpublish/Delete actions wired to server actions
  - AlertDialog for delete confirmation
  - Toast notifications for success/error
  - Loading state during mutations
- Created src/components/educator/EducatorCourseRow.tsx (list view, not grid):
  - Horizontal row layout matching product-plan design reference
  - Clickable course image (links to edit page)
  - Badges using same styles as landing: type badge (WSET, CATA, etc), modality (Online/Presencial), status (Publicado/Borrador)
  - Title, description (truncated), meta info (alumnos, fecha, duración)
  - Price displayed on right side
  - Dropdown menu with: Editar, Ver estudiantes, Publicar/Despublicar, Eliminar
- Created src/components/educator/EducatorCourseCard.tsx (grid view, kept for potential future use)
- Created src/components/shared/FilterButton.tsx as reusable component
- Created src/components/shared/SearchFilterBar.tsx as reusable component (search + filter button)
- Created src/components/shared/FiltersPanel.tsx as reusable component (configurable filter panel)
- Refactored landing CourseCatalog to use shared SearchFilterBar and FiltersPanel
- Refactored educator CourseList to use shared SearchFilterBar and FiltersPanel
- Both educator and landing now share the same search/filter UI with consistent behavior
- Educator panel now includes tags filter (fetched from getTags service)
- Added shadcn/ui components: Badge, DropdownMenu, AlertDialog

**Technical Notes:**
- List view (EducatorCourseRow) matches product-plan/sections/educator-panel/CourseList.png
- Badges use same colors as landing CourseCard for consistency
- Search is client-side with useMemo for performance
- FilterButton extracted to shared components for reuse
- Page is a Server Component that fetches educator courses before rendering
- Uses useTransition for non-blocking mutations
- Filters applied client-side from URL searchParams for instant feedback
- Delete requires confirmation via AlertDialog to prevent accidental deletion
- Actions call server actions which validate ownership and revalidate paths
- Items 4.08 and 4.10 implemented together since CourseList includes all action wiring

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create presencial course editor form (4.09)

---

## 2026-01-08 - Course Detail Page Tags Display (4.08b)

**Completed (minor enhancement):**
- Added tags display to CourseDetailPage.tsx hero section
- Tags appear below the status badge using verde-uva-500 background (same as landing cards)
- Consistent tag styling across landing cards and course detail page

**Technical Notes:**
- Tags rendered conditionally when course.tags.length > 0
- Uses same visual style as CourseCard tags for UI consistency
- Tags and status badge both displayed in flex-wrap container with gap-2

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create presencial course editor form (4.09)

---

## 2026-01-08 - Presencial Course Editor Form (4.09)

**Completed (PRD item 4.09):**
- Added generateSlug function to src/lib/utils.ts (handles Spanish accents, ñ, spaces)
- Added checkSlug function to src/services/course-service.ts (checks slug uniqueness)
- Added checkSlugAction to src/app/educator/actions.ts
- Created src/components/educator/presencial-course-form.tsx with all required sections:
  - Informacion Basica: title, slug (with auto-generate button), type selector
  - WSET level selector (appears when type=wset)
  - Course image upload using ImageUpload component (Vercel Blob)
  - Fechas y Duracion: startDate, endDate, duration
  - Ubicacion: location, address
  - Capacidad y Precio: maxCapacity, priceUSD
- Updated src/app/educator/courses/create/page.tsx to use PresencialCourseForm
- Created src/app/educator/courses/[id]/edit/page.tsx for editing existing courses
- Added shadcn/ui Select and Textarea components

**Technical Notes:**
- Slug generation adapted from v3: handles accents (á→a), ñ→n, removes special chars
- Real-time slug availability check with debounce (500ms)
- Visual feedback for slug status: checking (spinner), available (check), taken (alert)
- Uses Zod 4 syntax: `error` function for conditional messages (replaces deprecated `required_error`)
- Zod 4 + react-hook-form compatibility: explicit types `useForm<Input, unknown, Output>`
- Form uses react-hook-form with zodResolver for validation
- ImageUpload component reused from profile with aspectRatio="video" for course images
- Edit page verifies course ownership before rendering form

**Verification:** typecheck ✓, lint ✓ (1 warning: React Compiler incompatible library), build ✓

**Next Priority:** Create students list page for a course (4.11)

---

## 2026-01-08 - Course Materials & Presencial Labeling (4.09b)

**Completed (extension to PRD item 4.09):**
- Created CourseMaterial model in Prisma schema with fields:
  - id, courseId, name, type (enum), url, description, order, timestamps
- Created MaterialType enum: link, image, document, video, other
- Created migration: 20260108172659_add_course_materials
- Created src/services/material-service.ts with CRUD operations
- Added material server actions to educator/actions.ts:
  - addMaterialAction, updateMaterialAction, deleteMaterialAction
- Created src/components/educator/materials-section.tsx with:
  - List of existing materials with type icons
  - Add material form with type selector
  - Image upload integration (Vercel Blob) for image type
  - URL input for documents, links, videos with contextual placeholders
  - Delete confirmation dialog
- Updated edit course page to show MaterialsSection
- Updated all UI texts to indicate "Curso Presencial":
  - Page titles: "Crear Curso Presencial", "Editar Curso Presencial"
  - Buttons: "Nuevo Curso Presencial"
  - Descriptions updated to clarify presencial context
- Updated placeholders to use Montevideo examples (Sinergia Faro)

**Technical Notes:**
- Materials can only be added after course creation (need courseId)
- Creation page shows note about adding materials after creating
- MaterialsSection uses local state for optimistic updates
- Types: document (PDFs, etc via external links), image (Vercel Blob), link, video (YouTube/Vimeo)
- Materials will be visible to enrolled students in future student panel

**Verification:** typecheck ✓, lint ✓ (1 warning: React Compiler), build ✓

**Next Priority:** Create students list page for a course (4.11)

---

## 2026-01-08 - Student List Page (4.11)

**Completed (PRD item 4.11):**
- Updated src/app/educator/students/page.tsx to show course selector:
  - Lists all educator's courses with enrollment count
  - Each course links to /educator/courses/[id]/students
  - Empty state for educators with no courses
- Created src/app/educator/courses/[id]/students/page.tsx:
  - RSC with auth verification and course ownership check
  - Fetches enrollments using getEnrollmentsByCourse
  - Dynamic metadata with course title
- Created src/components/educator/student-list.tsx with:
  - Header with course title and description
  - 4 metric cards: Total inscritos, Confirmados, Pendientes, Cancelados
  - Search input to filter by name/email
  - Table with columns: Estudiante (avatar+name), Email, Fecha inscripcion, Estado
  - Status badges: Pendiente (yellow), Confirmado (green), Cancelado (gray)
  - Email action button for each student
  - Empty states: no students enrolled / no search results
- Added shadcn/ui Table component

**Technical Notes:**
- Visual design adapted from ProductPlan reference (StudentList.png) to project colors
- Uses verde-uva-100/700 for avatars and accent colors
- Metrics grid uses same card style as educator dashboard
- Table uses shadcn/ui Table with hover states
- StudentList component uses explicit type for EnrollmentWithStudent matching service return
- No need for separate student-row.tsx - used inline table rows

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Verify migrated data and seed fallback if needed (4.12)

---

## 2026-01-08 - Data Verification (4.12)

**Completed (PRD item 4.12):**
- Created temporary verification script using pg library to query database directly
- Verified all migrated data:
  - 226 students migrated from v3
  - 248 enrollments (246 confirmed, 2 pending)
  - All 17 courses have correct enrolledCount matching confirmed enrollments
- No seed fallback needed - migration was successful
- All verification commands pass (typecheck, lint, build)

**Technical Notes:**
- Used pg library directly (not Prisma client) because Neon serverless adapter requires WebSocket in Node.js
- Query verified enrolledCount by comparing Course.enrolledCount with COUNT of confirmed enrollments
- All counts match perfectly - migration script correctly updated enrolledCount values
- Script removed after verification (not needed in codebase)

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Add empty states and loading skeletons to educator pages (4.13)

---

## 2026-01-08 - Loading Skeletons and Suspense Boundaries (4.13)

**Completed (PRD item 4.13):**
- Created src/components/educator/skeletons.tsx with all skeleton components:
  - DashboardSkeleton - for educator dashboard with metrics grid, charts, and quick course cards
  - CourseListSkeleton - for courses page with search bar, filters, and course row placeholders
  - StudentListSkeleton - for course-specific student list with metrics and table rows
  - AllStudentsListSkeleton - for all students page with filters and table rows
- Added Suspense boundaries to all educator pages:
  - src/app/educator/page.tsx - wraps DashboardContent
  - src/app/educator/courses/page.tsx - wraps CoursesContent
  - src/app/educator/students/page.tsx - wraps StudentsContent
  - src/app/educator/courses/[id]/students/page.tsx - wraps CourseStudentsContent
- Updated src/components/educator/index.ts to export all skeleton components
- Empty states already implemented in previous PRD items (4.08, 4.11)

**Technical Notes:**
- Skeletons use Tailwind's animate-pulse for consistent loading animation
- Each skeleton mirrors the structure of its corresponding component
- Extracted data-fetching logic into separate async components for proper Suspense streaming
- Pattern follows existing landing page skeleton structure for consistency
- Skeletons use same styling tokens (bg-muted, rounded corners) as landing page

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Ensure responsive design and mobile usability (4.14)

---

## 2026-01-08 - Responsive Design for Educator Pages (4.14)

**Completed (PRD item 4.14):**
- Simplified course status workflow: publishCourse now goes directly to 'enrolling' (skipping 'announced')
- Fixed educator-course-row.tsx for mobile stacking:
  - Changed main flex to `flex-col sm:flex-row` for proper mobile layout
  - Image now full width on mobile, fixed size on desktop
  - Updated Image sizes attribute for responsive loading
  - Price and actions row adapts to mobile (horizontal) vs desktop (vertical)
- Fixed student-list.tsx table for mobile:
  - Added `overflow-x-auto` to table container
  - Hide Email column on mobile (`hidden md:table-cell`)
  - Hide Date column on smaller screens (`hidden lg:table-cell`)
  - Show email below name on mobile (like all-students-list.tsx pattern)
  - Avatar hidden on very small screens (`hidden sm:flex`)
  - Added `whitespace-nowrap` to status badge to prevent wrapping
- Added mobile menu to PublicHeader (landing page) matching AppShell pattern:
  - Logo on left, hamburger button on right (matching AppShell mobile header)
  - Left-side sliding overlay menu (same style as authenticated panels)
  - Menu includes: WSET, Cursos links in navigation section
  - User section reuses UserDropdown component (same as desktop) for consistency
  - Backdrop overlay closes menu on click
  - All links close menu on navigation for better UX
- Verified existing responsive patterns are correct:
  - Dashboard metrics: `sm:grid-cols-2 lg:grid-cols-4` ✓
  - Course form: `sm:grid-cols-2` for type/price fields ✓
  - All-students-list: Already had good responsive design ✓

**Technical Notes:**
- Mobile breakpoints used consistently: sm (640px), md (768px), lg (1024px)
- Pattern: stack vertically on mobile, horizontal on larger screens
- Tables: hide columns progressively, show inline data on mobile
- Images: use responsive sizes attribute for Next.js Image optimization
- Mobile menu uses overlay pattern matching AppShell (left-side sidebar + backdrop)

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Add tag selector/creator component to course editor (4.15)

---

## 2026-01-08 - Tag Selector Component (4.15)

**Completed (PRD item 4.15):**
- Created TagSelector component with modern Combobox pattern (Command + Popover)
- Updated tag-service.ts with createTag function and slug generation
- Added server actions: getTagsAction, createTagAction
- Updated course-service.ts to handle tagIds in createCourse and updateCourse
- Integrated TagSelector into presencial-course-form.tsx
- Updated create/edit course pages to pass initialTags
- Fixed pre-existing lint error in public-header.tsx (replaced mounted state with suppressHydrationWarning)

**TagSelector Features:**
- Searchable/filterable list of existing tags
- Selected tags shown as removable badges below input
- "Crear tag" option appears when search doesn't match existing tags
- Inline tag creation with auto-generated slug
- Loading states for fetching and creating tags
- Uses verde-uva-100/800 colors for badge styling

**Technical Notes:**
- Tags use Prisma `set` operation for updates (replaces all tags with new set)
- Tags use `connect` operation for create (links existing tags by ID)
- createTag returns existing tag if slug already exists (prevents duplicates)
- Form sends tagIds as JSON string in formData, parsed server-side
- TagSelector is fetches tags on mount if not provided via initialTags prop

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**MILESTONE 4 COMPLETE** - All PRD items pass.

---

## 2026-01-09 - Student Milestone Start (3.01)

**Completed (PRD item 3.01):**
- Extended Student model in Prisma schema with new fields:
  - Billing: billingName, billingTaxId, billingAddress (all optional String)
  - Notifications: notifyNewCourses (default true), notifyPromotions (default false), notifyCourseUpdates (default true)
- Created migration: 20260109115802_extend_student_profile
- Generated Prisma client with new types

**Technical Notes:**
- Created branch `feature/03-student` for this milestone
- All billing fields are optional to avoid breaking existing student records
- Notification preferences have sensible defaults (no marketing spam by default)
- Pre-existing lint warnings (3) are unrelated to this change

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Update student sidebar navigation (3.02)

---

## 2026-01-09 - Student Navigation (3.02)

**Completed (PRD item 3.02):**
- Updated studentNavItems in navigation-config.ts:
  - Panel de Control (/student) with LayoutDashboard icon
  - Mis Cursos (/student/courses) with BookOpen icon
  - Mi Perfil (/student/profile) with User icon
- Removed obsolete entries: Continuar, Calendario, Mi Progreso, Mis Datos
- Cleaned up unused imports (PlayCircle, Calendar, TrendingUp)

**Technical Notes:**
- Navigation now matches educator sidebar structure (3 main items)
- Avatar at bottom is handled by AppShell (already implemented)
- Old pages still exist but will be removed in PRD 3.15

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Create student-service for dashboard metrics (3.03)

---

## 2026-01-09 - Student Service (3.03)

**Completed (PRD item 3.03):**
- Created src/services/student-service.ts with all required functions:
  - getStudentByUserId(userId) - fetch student with user relation
  - getStudentById(studentId) - fetch student by ID
  - getStudentDashboardMetrics(studentId) - returns dashboard metrics:
    - totalCourses, inProgressCourses, completedCourses, upcomingCoursesCount
    - upcomingCourses (sorted by startDate, max 3)
    - recentCourses (last 3 enrolled)
  - getStudentProfile(studentId) - full student data for editing
  - updateStudentProfile(studentId, data) - update student fields

**Technical Notes:**
- Follows same pattern as educator-service for consistency
- Only counts confirmed enrollments for metrics
- StudentCourseQuickAccess interface includes educator name for display
- UpdateStudentInput includes all new billing/notification fields from PRD 3.01
- Queries include educator relation for course cards

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Extend enrollment-service for student operations (3.04)

---

## 2026-01-09 - Enrollment Service Extension (3.04)

**Completed (PRD item 3.04):**
- Added getStudentEnrollments(studentId, filters?) to enrollment-service.ts:
  - Optional status filter (EnrollmentStatus)
  - Returns enrollments with full course data including materials
  - Includes educator info (id, name, imageUrl)
  - Includes tags and materials ordered by order field
- Added getEnrollmentWithCourseDetails(enrollmentId):
  - Full student data with user email/name
  - Full course data with educator details (name, title, bio, imageUrl)
  - All course materials and tags

**Technical Notes:**
- Kept existing getEnrollmentsByStudent for backwards compatibility
- New functions provide richer data needed for student UI
- Materials are always ordered by 'order' field for consistent display
- Educator select includes imageUrl for avatar display in UI

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Create server actions for student operations (3.05)

---

## 2026-01-09 - Student Server Actions (3.05)

**Completed (PRD item 3.05):**
- Created src/app/student/actions.ts with all required server actions:
  - getAuthenticatedStudent() - helper to verify session and fetch student record
  - updateStudentProfileAction(formData) - validates with Zod, updates profile fields
  - updateNotificationPreferencesAction(preferences) - updates notification settings
- Actions verify user role is 'student' before allowing mutations
- Actions use student-service.ts updateStudentProfile function
- revalidatePath called for /student/profile and /student after updates

**Technical Notes:**
- Follows same pattern as educator/actions.ts for consistency
- Uses ActionResult<T> generic type for consistent success/error responses
- Zod schemas validate profile data with Spanish error messages
- Profile action filters undefined values to only update provided fields
- Notification preferences action takes object directly (not FormData) for type safety

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Create student dashboard page with metrics (3.06)

---

## 2026-01-09 - Student Dashboard Page (3.06)

**Completed (PRD item 3.06):**
- Updated src/app/student/page.tsx as RSC with:
  - Auth verification and student lookup
  - Fetches metrics using getStudentDashboardMetrics
  - Suspense boundary with inline skeleton fallback
- Created src/components/student/student-dashboard.tsx with:
  - Welcome message with student first name
  - 4 MetricCards: Cursos Inscritos (highlight), En Curso, Completados, Próximos
  - "Explorar Cursos" button linking to /#catalog
  - Recent courses grid (max 3) with StudentCourseQuickCard
  - Upcoming courses section (shows if different from recent)
  - Empty state with friendly message and CTA for students with no courses

**Technical Notes:**
- Reuses MetricCard from educator components (same visual style)
- StudentCourseQuickCard is a local component within dashboard (can be extracted later if needed)
- Cards link to /student/courses/[id] (will be implemented in PRD 3.09)
- Uses toLocalDate for proper timezone handling of dates
- Uses Badge component with same variants as educator panel

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Create student course list page with filters (3.07)

---

## 2026-01-09 - Student Course List Page (3.07)

**Completed (PRD item 3.07):**
- Created src/app/student/courses/page.tsx as RSC with:
  - Auth verification using resolveStudentForPage (supports view-as feature)
  - Fetches confirmed enrollments using getStudentEnrollments
  - Suspense boundary with inline skeleton fallback
  - URL query param support for status filter (?status=in_progress)
- Created src/components/student/student-course-list.tsx with:
  - Header with BookOpen icon, course count, and "Explorar Cursos" CTA button
  - Filter chips: Todos, En Progreso, Completados (rounded-full style)
  - URL-based filtering using router.push with searchParams
  - Sorted courses: in_progress first, then upcoming, then completed
  - Empty state for no enrollments (dashed border, GraduationCap icon, CTA)
  - Empty state for no filter results with "Ver todos los cursos" button
- Created src/components/student/student-course-row.tsx with horizontal card layout:
  - Image on the left (clickable to course detail)
  - Badges layout: type + status on the left, location/modality on the right
  - Title, educator name, tags (max 4, verde-uva style)
  - Meta info row: date, duration, materials count
  - "Ver detalles" button on the right
  - Same styling as EducatorCourseRow for consistency

**Technical Notes:**
- StudentCourseRow follows same pattern as EducatorCourseRow (horizontal layout)
- Badge layout matches CourseCard: type top-left, location top-right
- Status badges: Completado (green), Próximamente (blue), En curso (amber)
- Tags use verde-uva-100/800 colors (same as landing)
- Shows materials count if course has materials attached
- Only shows confirmed enrollments (students only see courses they're actually enrolled in)
- Filter "En Progreso" includes both in_progress and upcoming courses
- Uses same styling patterns as educator panel (rounded-2xl cards, stone colors)
- Properly typed using Prisma return types from getStudentEnrollments

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Create student course card component (3.08)

---

## 2026-01-09 - Student Course Card Component (3.08)

**Completed (PRD item 3.08):**
- Renamed student-course-row.tsx to student-course-card.tsx (per PRD naming)
- Added expandable materials section with:
  - Toggle button showing materials count with chevron icon
  - Collapsible list of materials when clicked
  - Icons per material type: document (FileText), image (Image), video (Video), link (Link2), other (File)
  - Material name, type label, and optional description
  - Download icon for documents/images, ExternalLink icon for links/videos
  - All materials open in new tab
- Updated StudentCourseList to use StudentCourseCard component

**Technical Notes:**
- Materials section uses useState for collapse state (client component)
- Icons and labels mapped from Prisma MaterialType enum
- External materials (link, video) show ExternalLink icon; downloadable (document, image, other) show Download icon
- Material items have hover state with bg-muted background
- PRD mentioned file sizes but model doesn't have that field; showing material type and description instead
- Same verde-uva-100/700 colors for material type icons as educator panel

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Create presencial course detail page for student (3.09)

---

## 2026-01-09 - Student Course Detail Page (3.09)

**Completed (PRD item 3.09):**
- Created src/app/student/courses/[id]/page.tsx as RSC with:
  - Auth verification using resolveStudentForPage (supports view-as feature)
  - Enrollment lookup using new getStudentEnrollmentByCourse function
  - Suspense boundary with skeleton fallback
  - Redirect to course list if not enrolled or enrollment not confirmed
  - notFound() if enrollment doesn't exist
- Added getStudentEnrollmentByCourse to enrollment-service.ts:
  - Uses Prisma's unique compound key (studentId_courseId)
  - Returns full course details with educator, materials, and tags
- Created src/components/student/student-course-detail.tsx with:
  - Hero header with course image, badges (type, status, modality), and title
  - Tags display below hero
  - Educator info card with avatar, name, title, and bio
  - Event details card for presencial courses:
    - Location with Google Maps link
    - Start/end dates formatted in Spanish
    - Duration
  - WSET certification info card (for WSET courses)
  - Materials section with download/open buttons per material type
  - Empty state for no materials
  - Back button to course list (preserves viewAs)

**Technical Notes:**
- Used getStudentEnrollmentByCourse instead of getEnrollmentWithCourseDetails because URL uses courseId, not enrollmentId
- Google Maps link built with location + address for better search results
- Materials show "Descargar" for files, "Abrir" for external links/videos
- Educator avatar shows User icon fallback if no imageUrl
- All dates use Spanish locale formatting

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Next Priority:** Implement material download functionality (3.10)

---

## 2026-01-09 - Material Download Functionality (3.10)

**Completed (PRD item 3.10):**
- Material download already implemented in StudentCourseDetail via direct links
- Access control verified at page level (only confirmed enrollments can view course detail)
- Materials open in new tab with appropriate icons (Download for files, ExternalLink for links/videos)

**Technical Notes:**
- No separate server action needed - access is implicitly verified by page-level auth
- Direct `<a href={material.url}>` links provide better UX than action-based downloads
- Security maintained because only enrolled students can access the course detail page

**Verification:** Functionality already working from 3.09 implementation

**Next Priority:** Create student profile page (3.11)

---

## 2026-01-09 - Student Profile Page (3.11)

**Completed (PRD item 3.11):**
- Created src/app/student/profile/page.tsx as RSC with:
  - Auth verification using resolveStudentForPage (supports view-as feature)
  - Fetches profile using getStudentProfile
  - Suspense boundary with ProfileSkeleton fallback
  - Read-only mode when superadmin views another student's profile
- Created src/components/student/student-profile.tsx with:
  - Header with title and description
  - Avatar section with ImageUpload component (rounded-full style)
  - Personal Info section: firstName, lastName, email (disabled), phone, dateOfBirth
  - Address section: address, city, zip, country
  - Billing section: billingName, billingTaxId, billingAddress (new fields from 3.01)
  - Notification preferences section with Switch toggles for each notification type
  - Sticky save button that appears only when changes are made
  - ProfileSection wrapper component with icon headers (verde-uva theme)
- Added shadcn/ui Switch component for notification toggles
- Form uses react-hook-form with Zod validation
- Wired to updateStudentProfileAction and updateNotificationPreferencesAction
- Shows toast on success/error using sonner

**Technical Notes:**
- ProfileSection component reuses verde-uva icon styling from educator panel
- Form handles nullable firstName/lastName from Prisma schema (|| '' defaults)
- Notification preferences use separate state to track dirty state independently
- Read-only mode disables all inputs when superadmin views student profile
- Avatar upload integrated but actual upload action will be in PRD 3.12
- Session update called when name changes to reflect in header immediately

**Verification:** typecheck ✓, lint ✓ (3 warnings, pre-existing), build ✓

**Enhancement (post-3.11):**
- Added identityDocument (CI) field to Student model
- Created migration: 20260109151517_add_student_identity_document
- Added CI field in Personal Info section
- Added "Usar mis datos personales" switch in Billing section:
  - When toggled ON, copies fullName, CI, and full address to billing fields
  - Uses react-hook-form watch() and setValue() for real-time updates
- Updated student-service.ts and actions.ts to handle identityDocument

**Next Priority:** Implement avatar upload for student profile (3.12)

---

## 2026-01-09 - Student Loading Skeletons (3.13)

**Completed (PRD item 3.13):**
- Created src/components/student/skeletons.tsx with all skeleton components:
  - StudentDashboardSkeleton - metrics grid (with highlight card), recent courses
  - StudentCourseListSkeleton - header, filter chips, course cards
  - StudentCourseDetailSkeleton - hero image, educator card, materials section
  - StudentProfileSkeleton - header, avatar section, form sections
- Updated all student pages to import skeletons from centralized file:
  - src/app/student/page.tsx - uses StudentDashboardSkeleton
  - src/app/student/courses/page.tsx - uses StudentCourseListSkeleton
  - src/app/student/courses/[id]/page.tsx - uses StudentCourseDetailSkeleton
  - src/app/student/profile/page.tsx - uses StudentProfileSkeleton
- Verified existing empty states are properly implemented:
  - StudentCourseList: "sin cursos" and "sin resultados de filtro"
  - StudentDashboard: "sin cursos" with CTA
  - StudentCourseDetail: "sin materiales" for empty materials section

**Technical Notes:**
- Skeletons follow same pattern as educator skeletons (animate-pulse, bg-muted)
- Highlight metric card skeleton uses verde-uva colors to match the actual component
- Pages still have Suspense boundaries wrapping async content components
- Centralizing skeletons in a single file improves maintainability and reusability
- All inline skeleton functions removed from pages in favor of imported components

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Enhancement (post-3.13):**
- Added user.image to all enrollment service queries that return student data:
  - getEnrollmentsByCourse, getEnrollmentWithCourseDetails, getEnrollmentById
  - getStudentEnrollmentByCourse, createEnrollment, updateEnrollmentStatus
  - getEducatorStudents
- Updated StudentTable component to display student avatar images:
  - Shows Image component when user.image exists
  - Falls back to initials when no image
- Updated AllStudentsList component with same avatar image pattern
- Updated type definitions in student-list.tsx and all-students-list.tsx

**Next Priority:** Ensure responsive design and mobile usability (3.14)

---

## 2026-01-09 - Responsive Design Polish (3.14)

**Completed (PRD item 3.14):**
- Reviewed all student components for mobile responsiveness
- All components already use proper responsive patterns:
  - StudentDashboard: grid-cols-2 lg:grid-cols-4 for metrics ✓
  - StudentProfile: sm:grid-cols-2 and flex-col sm:flex-row ✓
  - StudentCourseList: flex-col sm:flex-row header ✓
  - StudentCourseCard: flex-col sm:flex-row layout ✓
- Enhanced touch targets (min 44px) for:
  - Material download/open buttons in StudentCourseDetail (min-h-[44px] min-w-[44px])
  - Material toggle button in StudentCourseCard (min-h-[44px] with hover state)
  - Material items in StudentCourseCard (p-3 min-h-[44px])
  - "Ver detalles" button in StudentCourseCard (min-h-[44px])
- Mobile-friendly button labels:
  - "Descargar"/"Abrir" text hidden on mobile (sm:inline) leaving only icons
  - Icons remain visible for compact mobile display

**Technical Notes:**
- Used min-h-[44px] as per Apple's HIG for touch targets
- Button labels use hidden sm:inline to show icons only on mobile
- Material toggle button has hover:bg-muted for better tap feedback
- All existing responsive patterns were already correct (grid-cols-2, flex-col sm:flex-row)

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Remove obsolete student pages (3.15)

---

## 2026-01-09 - Remove Obsolete Student Pages (3.15)

**Completed (PRD item 3.15):**
- Removed obsolete student page directories:
  - src/app/student/continue/ (was placeholder)
  - src/app/student/calendar/ (was placeholder)
  - src/app/student/progress/ (was placeholder)
  - src/app/student/data/ (replaced by /student/profile)
- Verified no internal links referenced old routes
- Navigation config already updated in PRD 3.02

**Final Student Route Structure:**
- /student → Dashboard (panel de control con métricas)
- /student/courses → Lista de cursos inscritos
- /student/courses/[id] → Detalle del curso
- /student/profile → Perfil del estudiante

**Technical Notes:**
- Required clearing .next cache before typecheck (cached references to deleted files)
- Build output confirms only 4 student routes remain
- Navigation config (studentNavItems) already matched final structure

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create student components barrel export (3.16)

---

## 2026-01-09 - Student Components Index (3.16)

**Completed (PRD item 3.16):**
- Created src/components/student/index.ts barrel export file
- Exports all main student components:
  - StudentDashboard, StudentCourseList, StudentCourseCard
  - StudentCourseDetail, StudentProfile
- Exports all skeleton components:
  - StudentDashboardSkeleton, StudentCourseListSkeleton
  - StudentCourseDetailSkeleton, StudentProfileSkeleton
- Exports view-as feature components:
  - ViewAsProvider, useViewAs, ViewAsBanner, AppShellWithBannerClient

**Technical Notes:**
- Barrel export follows same pattern as educator/index.ts
- Includes all components found in src/components/student/ directory
- Organized by category: main components, skeletons, view-as feature

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**MILESTONE 3 (Student) COMPLETE** - All 16 PRD items pass.

---

## 2026-01-09 - Checkout Milestone Start (6.01)

**Completed (PRD item 6.01):**
- Added Order model to prisma/schema.prisma with all required fields:
  - Identification: id, orderNumber (unique, format TA-YYYYMMDD-XXXX)
  - Relations: userId, courseId, studentId?, couponId?, bankAccountId?
  - Pricing: originalPriceUSD, originalPriceUYU?, discountPercent, discountAmount, finalAmount, currency
  - Payment: paymentMethod, status
  - MercadoPago: mpPreferenceId?, mpPaymentId?, mpStatus?, mpStatusDetail?
  - Bank transfer: transferReference?
  - Timestamps: createdAt, updatedAt, paidAt?, cancelledAt?, refundedAt?
- Added enums: OrderStatus, PaymentMethod, Currency
- Added orders relation to User, Student, and Course models
- Added all required indexes

**Technical Notes:**
- Created branch `feature/06-checkout` for this milestone
- couponId and bankAccountId fields are present but relations to Coupon and BankAccount models will be added in PRD 6.02 and 6.03
- No migration run yet - will migrate after all schema changes (6.04)
- Prisma generate successful with new types
- Pre-existing lint warnings (4) are unrelated to this change

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Add BankAccount model (6.02)

---

## 2026-01-09 - BankAccount Model (6.02)

**Completed (PRD item 6.02):**
- Added BankAccount model to prisma/schema.prisma with all required fields:
  - id, bankName, accountHolder, accountType, accountNumber
  - currency (uses Currency enum)
  - swiftCode?, routingNumber? (for international transfers)
  - displayOrder (for ordering in UI)
  - notes? (internal notes)
  - isActive (default true)
  - createdAt, updatedAt
- Added orders relation (Order[]) to BankAccount
- Added bankAccount relation to Order model
- Added indexes on currency and isActive

**Technical Notes:**
- BankAccount supports multiple currencies (USD, UYU) using existing Currency enum
- displayOrder allows admin to control which accounts appear first
- isActive flag for soft-disabling accounts without deleting
- Relation from Order to BankAccount now fully connected (was placeholder in 6.01)
- No migration run yet - will migrate after all schema changes (6.04)

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Add Coupon model (6.03)

---

## 2026-01-09 - Coupon Model (6.03)

**Completed (PRD item 6.03):**
- Added Coupon model to prisma/schema.prisma with all required fields:
  - id, code (unique)
  - discountPercent (0-100)
  - maxUses, currentUses (for usage tracking)
  - restrictedToEmail?, restrictedToCourseId? (restrictions)
  - minPurchaseAmount? (minimum purchase requirement)
  - validFrom, expiresAt? (validity period)
  - isActive (default true)
  - description?, createdBy? (admin metadata)
  - createdAt, updatedAt
- Added coupon relation to Order model
- Added coupons relation to Course model (for restricted coupons)
- Added indexes on code, isActive, expiresAt, restrictedToEmail

**Technical Notes:**
- Coupons can be restricted to specific email addresses (personal coupons)
- Coupons can be restricted to specific courses
- minPurchaseAmount allows minimum cart value requirements
- maxUses/currentUses track usage limits
- All checkout models (Order, BankAccount, Coupon) now complete
- No migration run yet - will migrate in 6.04

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Run migration and finalize schema changes (6.04)

---

## 2026-01-09 - Checkout Schema Migration (6.04)

**Completed (PRD item 6.04):**
- Added priceUYU: Float? field to Course model (for MercadoPago pricing)
- Ran prisma migrate dev --name add_checkout_models
- Migration created all checkout tables and enums in a single SQL file

**Migration Summary (20260109190018_add_checkout_models):**
- Created 3 enums: OrderStatus, PaymentMethod, Currency
- Created 3 tables: BankAccount, Coupon, Order
- Added priceUYU column to Course table
- Created all indexes for performance
- Added all foreign key constraints

**Technical Notes:**
- Items 6.01-6.03 added schema changes without migrating (prisma generate only)
- Item 6.04 consolidated all changes into a single migration
- This approach avoids multiple small migrations and ensures atomicity
- Database now fully supports checkout flow:
  - Orders track purchases with MercadoPago or bank transfer
  - BankAccounts store transfer destination info
  - Coupons enable discount codes with restrictions

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create migration script for v3 BankData and Coupons (6.05)

---

## 2026-01-09 - Checkout Data Migration Script (6.05)

**Completed (PRD item 6.05):**
- Created scripts/migration/migrate-checkout-data.ts with:
  - Connection to v3 PostgreSQL database via pg library
  - BankData migration: parses v3 info string into structured BankAccount fields
  - Coupon migration: transfers active coupons (not expired, uses < maxUses)
  - Course ID mapping: builds slug-based mapping v3 → v4 for course restrictions
  - Duplicate detection: skips already migrated records
  - Detailed logging of migration progress
- Added `migrate:checkout` script to package.json

**Migration Features:**
- parseBankInfo() function parses v3's multi-line info string into:
  - bankName, accountHolder, accountType, accountNumber
- Course-restricted coupons: maps v3 courseId to v4 by matching slugs
- Preserves coupon usage counts (currentUses) from v3
- Saves original v3 info as notes field for reference
- Handles missing tables gracefully (checks table existence before querying)

**Technical Notes:**
- Follows same pattern as existing migration scripts (migrate-educators.ts)
- Uses DIRECT_DATABASE_URL to bypass connection pooler
- Table existence check prevents errors if v3 schema differs
- Course mapping issues logged but don't block migration
- Manual review recommended after migration for bank account details

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create order-service for order management (6.06)

---

## 2026-01-09 - Order Service (6.06)

**Completed (PRD item 6.06):**
- Created src/services/order-service.ts with all required functions:

**Types:**
- CreateOrderInput: userId, courseId, paymentMethod, currency, couponId, pricing fields
- UpdateOrderStatusMetadata: optional fields for status updates (MP data, timestamps, studentId)
- orderWithRelations: shared include config for full order details

**Queries:**
- getOrderById(id): OrderWithRelations | null
- getOrderByNumber(orderNumber): OrderWithRelations | null
- getOrdersByUserId(userId): OrderWithRelations[]
- getOrdersByStatus(status): OrderWithRelations[]
- getOrderByMpPreferenceId(preferenceId): Order | null
- getOrderByMpPaymentId(paymentId): Order | null
- getPendingTransferOrders(): OrderWithRelations[] (for admin review)
- getOrders(filters?): paginated list with status, paymentMethod, courseId, userId filters
- getUserOrderForCourse(userId, courseId): check existing orders

**Mutations:**
- createOrder(input): creates order with auto-generated unique orderNumber
- updateOrderStatus(orderId, status, metadata?): flexible status update
- setMercadoPagoPreference(orderId, preferenceId): save MP preference
- cancelOrder(orderId): sets cancelled status with timestamp
- markTransferAsSent(orderId, reference?, proofUrl?): user marks transfer done
- linkStudentToOrder(orderId, studentId): post-payment linking
- markOrderAsPaid(orderId, studentId?): marks paid with timestamp
- refundOrder(orderId): marks refunded with timestamp

**Helper:**
- generateOrderNumber(): format TA-YYYYMMDD-XXXX with retry for uniqueness

**Technical Notes:**
- Follows same pattern as enrollment-service for consistency
- orderWithRelations includes user, course (with educator/tags), student, coupon, bankAccount
- Order number generation has retry logic (max 5 attempts) for collision handling
- All mutations include orderWithRelations by default for immediate UI updates

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create coupon-service for discount validation (6.07)

---

## 2026-01-09 - Coupon Service (6.07)

**Completed (PRD item 6.07):**
- Created src/services/coupon-service.ts with all required functions:

**Types:**
- CouponError: union type for all validation error codes
- ValidateCouponResult: { valid, coupon?, error?, errorMessage?, discountPercent?, discountAmount?, finalAmount? }
- CreateCouponInput, UpdateCouponInput: input types for mutations

**Queries:**
- getCouponByCode(code): Coupon | null (normalizes to uppercase)
- getCouponById(id): Coupon | null
- getAllCoupons(): Coupon[]
- getActiveCoupons(): active coupons (isActive, not expired, validFrom passed)
- getCoupons(filters?): admin list with search, isActive, courseId filters

**Validation:**
- validateCoupon(code, userEmail, courseId, originalAmount): ValidateCouponResult
  - Checks: exists, isActive, validFrom, expiresAt, usage limit, email restriction, course restriction, min amount
  - Calculates: discountPercent, discountAmount, finalAmount
  - Returns Spanish error messages for each validation failure

**Mutations:**
- incrementCouponUsage(couponId): atomic increment of currentUses
- createCoupon(input): admin creation (normalizes code to uppercase)
- updateCoupon(id, input): admin update with partial fields
- deactivateCoupon(id): soft delete (isActive=false)
- reactivateCoupon(id): restore deactivated coupon
- deleteCoupon(id): hard delete (only if no orders linked)

**Technical Notes:**
- All coupon codes normalized to uppercase for case-insensitive matching
- Emails normalized to lowercase for consistent comparison
- Discount calculations rounded to 2 decimal places
- Error messages in Spanish for user-facing validation
- deleteCoupon checks order count before deletion

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create bank-account-service for transfer payment data (6.08)

---

## 2026-01-09 - Bank Account Service (6.08)

**Completed (PRD item 6.08):**
- Created src/services/bank-account-service.ts with all required functions:

**Types:**
- CreateBankAccountInput: bankName, accountHolder, accountType, accountNumber, currency, optional fields
- UpdateBankAccountInput: partial input for updates with nullable fields support

**Queries:**
- getBankAccountById(id): BankAccount | null
- getAllBankAccounts(): BankAccount[] (for admin, ordered by displayOrder)
- getActiveBankAccounts(): BankAccount[] (for checkout, only isActive=true)
- getBankAccountsByCurrency(currency): BankAccount[] (filtered by currency)

**Mutations:**
- createBankAccount(input): creates new bank account with defaults
- updateBankAccount(id, input): updates specified fields only
- toggleBankAccountStatus(id): flips isActive boolean
- deleteBankAccount(id): hard delete if no orders linked, throws error otherwise
- reorderBankAccounts(orderedIds): updates displayOrder for all accounts in transaction

**Technical Notes:**
- Follows same pattern as order-service and coupon-service for consistency
- Uses Prisma transactions for reorderBankAccounts to ensure atomicity
- deleteBankAccount checks order count before deletion, suggests soft delete if orders exist
- Error messages in Spanish for user-facing errors
- All queries ordered by displayOrder then createdAt for consistent ordering

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create mercadopago-service for payment gateway integration (6.09)

---

## 2026-01-09 - MercadoPago Service (6.09)

**Completed (PRD item 6.09):**
- Reviewed v3 implementation in /home/raphael/desarrollo/tinta-academy-v3/src/services/order-services.ts
- Installed mercadopago package v2.11.0
- Added environment variables to .env.example:
  - MERCADOPAGO_ACCESS_TOKEN
  - MERCADOPAGO_PUBLIC_KEY
  - MERCADOPAGO_WEBHOOK_SECRET
  - MERCADOPAGO_SANDBOX (true/false)
- Created src/services/mercadopago-service.ts with all required functions:

**Config:**
- getMercadoPagoClient(): lazily creates MercadoPagoConfig with accessToken
- isSandbox flag for sandbox/production mode

**Types:**
- CreatePreferenceInput: orderId, courseId, courseTitle, amount, URLs, user info
- PreferenceResult: preferenceId, initPoint URL
- PaymentInfo: id, status, statusDetail, externalReference, transactionAmount, orderId

**Functions:**
- createPreference(input): creates MP preference, returns preferenceId and initPoint URL
- getPayment(paymentId): fetches payment details from MP API
- verifyPaymentStatus(paymentId): returns status, statusDetail, orderId
- validateWebhookSignature(dataId, xSignature, xRequestId): HMAC-SHA256 validation
- isMercadoPagoConfigured(): checks if service is configured
- getMercadoPagoMode(): returns 'sandbox' or 'production'

**Technical Notes:**
- Followed v3 pattern: Preference for checkout, Payment for webhook verification
- Uses sandbox_init_point vs init_point based on MERCADOPAGO_SANDBOX env
- Webhook signature validation follows MP's format: ts=timestamp,v1=hash
- Uses crypto.timingSafeEqual for secure hash comparison
- Auto_return set to 'approved' for better UX
- Currency set to UYU for Uruguay market

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create checkout-service for checkout flow orchestration (6.10)

---

## 2026-01-09 - MercadoPago Service Security Audit Response (6.09b)

**Audit Review:** plans/audit/audit_2026-01-09.txt
**Response Document:** plans/audit/audit_2026-01-09_response.txt

**Bug Fixes Applied:**

1. **CRÍTICO - timingSafeEqual buffer length crash:**
   - Agregada verificación de longitud de buffers antes de timingSafeEqual
   - Sin esto, hashes de diferente longitud causaban crash del servidor
   - Ahora retorna false con log de error en lugar de crashear

2. **RECOMENDADO - Verificación temporal de timestamp:**
   - Agregada constante WEBHOOK_MAX_AGE_MS = 5 minutos
   - Webhooks con timestamp > 5 min son rechazados
   - Previene replay attacks donde atacante reenvía webhook capturado
   - Permite 1 minuto de clock skew hacia el futuro

**Cambios V3→V4 Justificados:**

| Cambio                  | Decisión | Razón                                      |
|-------------------------|----------|---------------------------------------------|
| notification_url        | MANTENER | Más robusto, sobrescribe config del panel   |
| auto_return: 'approved' | MANTENER | Mejora UX, redirección automática           |
| currency_id: 'UYU'      | MANTENER | SDK 2.x lo recomienda, más explícito        |
| payer info (email/name) | MANTENER | Pre-rellena checkout, mejora UX             |

**Notas de Migración:**
- Variables de entorno renombradas (MP_* → MERCADOPAGO_*)
- Ver tabla completa en audit_2026-01-09_response.txt

**Verification:** typecheck ✓, lint ✓ (4 warnings, pre-existing), build ✓

**Next Priority:** Create checkout-service for checkout flow orchestration (6.10)

---
