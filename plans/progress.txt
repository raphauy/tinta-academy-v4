# Progress Log - Tinta Academy

This file tracks progress across Ralph sessions. Each entry documents what was implemented, technical decisions, and suggestions for next steps.

---

## 2026-01-06 - Initial Setup

Created Ralph Wiggum infrastructure:
- plans/ralph-once.sh - Human-in-the-loop script
- plans/AGENT.md - Build/test instructions
- plans/progress.txt - This file
- plans/prd/02-landing.json - Milestone 2 PRD

Foundation (Milestone 1) was already implemented:
- NextAuth with OTP login
- App shells for all roles (public, student, educator, admin)
- Basic Prisma schema (User, Student, Educator, OtpToken)
- Routing structure with role-based protection

Next: Start implementing Milestone 2 - Landing & Catalog

---

## 2026-01-06 - Database Schema & API Foundation

**Completed (PRD items 2.01-2.09):**
- Added Course, Tag, and NewsletterSubscription models to Prisma schema
- Created CourseType, CourseModality, and CourseStatus enums  
- Implemented many-to-many relationship between Course and Tag
- Added wsetLevel field for WSET courses
- Enhanced seed script with 3 educators, 6 tags, and 6 sample courses
- Created API routes: /api/courses (with filtering), /api/tags, /api/newsletter

**Technical Notes:**
- Used Prisma migrations instead of db push for better version control
- API routes support query parameters for filtering courses by modality, type, tagIds
- Courses are automatically separated into upcoming vs past based on startDate and status
- Newsletter API uses Zod validation and handles duplicate emails gracefully

**Next Priority:** UI components (CourseCard, CourseCatalog, Hero, Footer)

---

## 2026-01-06 - API Routes Refactor to Server Actions

**Completed (PRD item 2.09b):**
- Replaced API routes (/api/courses, /api/tags, /api/newsletter) with service layer architecture
- Created course-service.ts with getCourses, getUpcomingCourses, getPastCourses functions
- Created tag-service.ts with getTags function  
- Created newsletter-service.ts with subscribe function
- Added subscribeToNewsletter server action in src/app/(public)/actions.ts
- Removed API route files and cleaned up empty directories

**Technical Notes:**
- Services use proper Prisma types (CourseWhereInput, CourseModality, CourseType enums)
- Server action includes Zod validation for email input
- Course filtering logic preserved with proper TypeScript typing
- Architecture now follows Next.js App Router patterns: RSC → Services → Prisma

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** UI components implementation (CourseCard, CourseCatalog, Hero, Footer)

---

## 2026-01-06 - Landing UI Components Implementation

**Completed (PRD item 2.10):**
- Created src/types/landing.ts - adapted types from product-plan to work with Prisma Course model
- Implemented all landing components in src/components/landing/:
  - CourseCard.tsx - with Next.js Image optimization and proper Prisma type integration
  - CourseCatalog.tsx - course filtering and catalog display
  - Hero.tsx - cinematic hero section with background image
  - Header.tsx - responsive navigation header
  - Footer.tsx - full institutional footer with newsletter subscription
  - LandingCatalogo.tsx - main landing page component orchestrating all sections
- Created index.ts barrel export for clean imports
- Fixed all ESLint warnings (Next.js Image usage, unused variables)

**Technical Notes:**
- Used Next.js Image component for optimized loading instead of regular img tags
- Adapted original product-plan types to match Prisma model structure (Date types, relation structure)
- Course cards display educator info from embedded relation, not separate lookup
- Removed unused educator parameter passing through component tree
- All components are client components due to React hooks usage ('use client' directive)

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Implement landing page with real data from services (PRD 2.11)

---

## 2026-01-06 - Landing Page Implementation

**Completed (PRD item 2.11):**
- Implemented landing page with real data from services in src/app/(public)/page.tsx
- Added data transformation functions to convert Prisma types to landing page component types
- Configured hero content, footer links, and contact information for the landing page
- Integrated getUpcomingCourses, getPastCourses from course-service
- Integrated getTags from tag-service
- Transformed Prisma Course model data to match expected landing page types
- Set up LandingCatalogo component with real course and tag data

**Technical Notes:**
- Created transformation functions (transformCourse, transformTag) to bridge Prisma nullable fields with component non-nullable requirements
- Landing page now displays actual seeded courses and tags from database
- Hero section configured with wine education messaging
- Footer configured with realistic institutional links and contact information
- Placeholder handlers added for future features (navigation, subscriptions, course details)

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Wire landing page interactions (filters, scroll, navigation) - PRD 2.12

---

## 2026-01-06 - v3 Database Migration

**Completed (PRD item 2.11b):**
- Created migration scripts in scripts/migration/:
  - migrate-educators.ts - Migrates educators from v3 to v4 (creates User + Educator)
  - migrate-courses.ts - Migrates courses with type/status mapping
- Added V3_DATABASE_URL to .env.local
- Successfully migrated:
  - 1 educator (Gabi Zimmer)
  - 4 courses (WSET Nivel 1, Taller top, Cata top, Curso Test)
  - 1 course skipped (already existed from seed)

**Technical Notes:**
- Used `pg` library directly instead of Prisma adapter (Neon serverless adapter requires WebSocket)
- Scripts use DIRECT_DATABASE_URL to bypass connection pooler for better reliability
- Type mapping: WSET_NIVEL_X → type=wset + wsetLevel=X
- Status mapping: Anunciado→announced, Inscribiendo→enrolling, Finalizado→finished
- Default modality 'presencial' (v3 doesn't have this field)
- Dates: classDates[0]→startDate, examDate or last classDate→endDate
- Duration string: "{totalDuration} horas"
- Educator mapping saved to educator-mapping.json for course migration dependency

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Wire landing page interactions (filters, scroll, navigation) - PRD 2.12

---

## 2026-01-06 - Landing Page Interactions

**Completed (PRD item 2.12):**
- Created LandingClientWrapper component to handle client-side interactions
- Implemented URL search params support for filtering (?modality=online&type=wset&tagIds=id1,id2)
- Wired onFilter callback to update URL params when user changes filters
- onHeroCTA already scrolls to catalog section (implemented in LandingCatalogo)
- onNavigate callback wired to use Next.js router for navigation
- onViewCourse callback navigates to /cursos/[slug]
- Added Suspense boundary with loading fallback for the landing page

**Technical Notes:**
- Used useMemo for memoizing currentFilters from searchParams to avoid unnecessary re-renders
- Used useMemo for filtered courses arrays (filteredUpcoming, filteredPast)
- Refactored page.tsx to separate data fetching (LandingData async component) from rendering
- LandingClientWrapper reads filters from URL and applies them client-side
- CourseCatalog now accepts onFilter callback and calls updateFilters for all filter changes
- Added id="catalog" to catalog section for potential direct linking

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Implement newsletter subscription flow - PRD 2.13

---

## 2026-01-06 - Newsletter Subscription Flow

**Completed (PRD item 2.13):**
- Wired onSubscribe callback in LandingClientWrapper to call subscribeToNewsletter server action
- Updated Footer component to support async onSubscribe with loading state
- Added loading spinner and disabled state during submission
- Integrated sonner toasts for success/error feedback
- Updated LandingCatalogoProps type to reflect async onSubscribe signature

**Technical Notes:**
- Footer now shows a loading spinner and disables input during submission
- Success toast: "¡Gracias por suscribirte!" with description about future updates
- Error toast: "Error al suscribirse" with specific error message from server action
- The existing subscribed state still shows the inline success message after successful subscription
- Type signature changed from `(email: string) => void` to `(email: string) => Promise<{ success: boolean; error?: string }>`

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Implement full course detail page with modern design - PRD 2.14

---

## 2026-01-06 - Course Detail Page

**Completed (PRD item 2.14):**
- Added getCourseBySlug function to course-service.ts with educator and tags relations
- Created src/app/(public)/cursos/[slug]/page.tsx as RSC with generateMetadata for SEO
- Created src/components/course-detail/CourseDetailPage.tsx with all required sections
- Extracted footer config to src/config/footer.ts for reuse across pages
- Shared Footer component between landing and course detail pages

**Verification:** All checks pass (typecheck, lint, build)

**Next Priority:** Polish landing page (empty states, responsive, loading) - PRD 2.15

---

## 2026-01-06 - Landing Page Polish

**Completed (PRD item 2.15):**
- Improved empty states in CourseCatalog:
  - "No hay cursos programados" when upcomingCourses is empty (with wine emoji)
  - "No se encontraron cursos" when filters return no results with prominent "Limpiar filtros" button
- Past courses section already hides when empty (was already implemented)
- Created CourseCatalogSkeleton component for loading states:
  - Header skeleton with animated pulse
  - 4 course card skeletons with image, title, date, description, tags, and footer placeholders
- Added Suspense boundary in landing page with LandingFallback component:
  - Hero skeleton (animated pulse)
  - CourseCatalogSkeleton for course grid

**Technical Notes:**
- Skeleton uses Tailwind animate-pulse for smooth loading animation
- Empty states use visual hierarchy: emoji icon, bold title, muted description
- "Limpiar filtros" button uses primary color and is prominently displayed
- Suspense boundary wraps LandingClientWrapper to show fallback during data loading

**Verification:** All checks pass (typecheck, lint, build)

**MILESTONE 2 COMPLETE** - All PRD items pass. Next milestone: 03-enrollment or 04-educator

---

## 2026-01-08 - Educator Milestone Start (4.01)

**Completed (PRD item 4.01):**
- Added 'draft' status to CourseStatus enum in Prisma schema
- Created migration: 20260108125218_add_draft_status
- Updated src/types/landing.ts to include 'draft' in Course status type

**Technical Notes:**
- Draft status placed before 'announced' in enum order (represents workflow: draft → announced → enrolling → ...)
- Draft courses will be used by educators to create courses before publishing
- Updated landing.ts type to match Prisma enum (required for type compatibility)
- Pre-existing lint errors in testimonials-section.tsx and user-dropdown.tsx not addressed (unrelated to this change)

**Verification:** typecheck ✓, build ✓ (lint has pre-existing errors unrelated to this change)

**Next Priority:** Create Enrollment model (4.02)

---

## 2026-01-08 - Enrollment Model (4.02)

**Completed (PRD item 4.02):**
- Created Enrollment model in Prisma schema with all required fields
- Created EnrollmentStatus enum: pending, confirmed, cancelled
- Added enrollments relation to Student model
- Added enrollments relation to Course model
- Added @@unique([studentId, courseId]) constraint to prevent duplicate enrollments
- Created migration: 20260108131146_add_enrollment

**Technical Notes:**
- Enrollment has onDelete: Cascade for both student and course relations
- Default status is 'pending' (new enrollments start as pending)
- enrolledAt defaults to now() for automatic timestamp on creation
- Indexes on studentId, courseId, and status for query performance

**Verification:** typecheck ✓

**Next Priority:** Migrate students from v3 database (4.02b)

---

## 2026-01-08 - Student Migration (4.02b)

**Completed (PRD item 4.02b):**
- Created scripts/migration/migrate-students.ts
- Migrated 226 students from v3 to v4 database
- Saved mapping to student-mapping.json for enrollment migration

**Technical Notes:**
- v3 Student model has email directly on Student (not on User like originally assumed)
- Script creates User with role=student + Student record for each v3 student
- Uses transaction for atomicity (User + Student created together)
- Handles duplicates by skipping if email already exists
- Maps all fields: firstName, lastName, dateOfBirth, phone, address, city, zip, country

**Verification:** typecheck ✓

**Next Priority:** Migrate enrollments from v3 Orders (4.02c)

---

## 2026-01-08 - Enrollment Migration (4.02c)

**Completed (PRD item 4.02c):**
- Created scripts/migration/migrate-enrollments.ts
- Migrated 248 enrollments from v3 Orders to v4 Enrollments
- Updated enrolledCount for 10 courses based on confirmed enrollments

**Technical Notes:**
- Course mappings built dynamically by querying both databases by slug (no separate mapping file needed)
- Status mapping: Paid → confirmed, Created/Pending/PaymentSent → pending, Rejected/Refunded/Cancelled → cancelled
- Handles duplicates (same student+course) by keeping confirmed status or most recent enrollment
- Uses Order.createdAt as enrolledAt timestamp
- Script automatically updates Course.enrolledCount based on confirmed enrollment count

**Verification:** typecheck ✓, lint ✓ (pre-existing errors only), build ✓

**Next Priority:** Create educator-service for dashboard metrics (4.03)

---

## 2026-01-08 - Educator Service (4.03)

**Completed (PRD item 4.03):**
- Created src/services/educator-service.ts with:
  - getEducatorByUserId(userId) - fetches educator with user relation
  - getEducatorById(educatorId) - fetches educator by ID
  - getEducatorDashboardMetrics(educatorId) - returns dashboard metrics

**Dashboard Metrics returned:**
- totalCourses: count of all educator courses
- publishedCourses: count of courses where status != 'draft'
- totalEnrollments: sum of enrolledCount across all courses
- upcomingCourses: array of courses with startDate > now and status in [announced, enrolling]

**Also fixed pre-existing lint errors:**
- testimonials-section.tsx: escaped quotes with &ldquo;/&rdquo;
- user-dropdown.tsx & user-menu.tsx: added eslint-disable for SSR hydration pattern
- migrate-all.ts: removed unused error variable in catch block

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Extend course-service for educator operations (4.04)

---

## 2026-01-08 - Course Service Educator Operations (4.04)

**Completed (PRD item 4.04):**
- Extended src/services/course-service.ts with educator-specific operations:
  - getEducatorCourses(educatorId, filters?) - fetches courses with status/type/modality filters
  - getCourseById(id) - fetches single course with relations
  - createCourse(data) - creates new presencial course with 'draft' status
  - updateCourse(id, data) - updates course fields selectively
  - publishCourse(id) - changes status from 'draft' to 'announced'
  - unpublishCourse(id) - changes status back to 'draft'
  - deleteCourse(id) - hard delete only if no enrollments

**Technical Notes:**
- CreateCourseInput and UpdateCourseInput interfaces exported for use in server actions
- getEducatorCourses includes enrollment count via _count relation
- updateCourse uses conditional spread to only update provided fields
- deleteCourse checks enrollment count and throws descriptive error if course has students
- New courses default to modality='presencial' (online support planned for later)
- Courses ordered by status (drafts first) then by startDate descending

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create enrollment-service for managing course enrollments (4.05)

---

## 2026-01-08 - Enrollment Service (4.05)

**Completed (PRD item 4.05):**
- Created src/services/enrollment-service.ts with all enrollment operations:
  - getEnrollmentsByCourse(courseId) - returns enrollments with student + user data
  - getEnrollmentsByStudent(studentId) - returns enrollments with course + educator data
  - getEnrollmentById(id) - fetches single enrollment with relations
  - createEnrollment(studentId, courseId) - creates new pending enrollment
  - updateEnrollmentStatus(id, status) - updates status with course count adjustment
  - cancelEnrollment(id) - convenience wrapper for cancellation
  - confirmEnrollment(id) - convenience wrapper for confirmation
  - getCourseEnrollmentStats(courseId) - returns counts by status

**Technical Notes:**
- createEnrollment checks for existing enrollment and course capacity before creating
- updateEnrollmentStatus uses transaction to atomically update enrollment and course.enrolledCount
- Course enrolledCount increments when status changes TO 'confirmed', decrements when FROM 'confirmed'
- All queries include relevant relations (student.user for email/name, course.educator for course queries)
- Error messages in Spanish for user-facing errors

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create server actions for educator course management (4.06)

---

## 2026-01-08 - Educator Server Actions (4.06)

**Completed (PRD item 4.06):**
- Created src/app/educator/actions.ts with all course management actions:
  - createCourseAction(formData) - validates with Zod, creates course as draft
  - updateCourseAction(courseId, formData) - validates and updates course fields
  - publishCourseAction(courseId) - changes status from 'draft' to 'announced'
  - unpublishCourseAction(courseId) - changes status back to 'draft'
  - deleteCourseAction(courseId) - deletes course (if no enrollments)

**Technical Notes:**
- All actions verify authentication (session required) and authorization (role=educator)
- All actions verify course ownership before mutation
- Zod schemas validate course data with Spanish error messages
- Uses explicit TypeScript return types for helper functions to ensure type narrowing
- revalidatePath called for /educator/courses, /educator, and / (landing) after mutations
- ActionResult generic type for consistent success/error responses

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create educator dashboard page with metrics (4.07)

---

## 2026-01-08 - Superadmin Course Access (4.06b)

**Completed (PRD item 4.06b):**
- Updated getAuthenticatedEducator() in src/app/educator/actions.ts
- Changed role check from `role !== 'educator'` to `role !== 'educator' && role !== 'superadmin'`
- Superadmins can now create and manage their own courses via educator panel

**Technical Notes:**
- This aligns actions.ts with middleware (proxy.ts) and layout.tsx which already allowed superadmin access
- Superadmin still needs an Educator record to associate courses (can be created via Prisma Studio or migration)
- No schema changes required - Prisma already supports User with any role having an Educator record
- Single line change with maximum impact

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create educator dashboard page with metrics (4.07)

---

## 2026-01-08 - Educator Dashboard Page (4.07)

**Completed (PRD item 4.07):**
- Updated src/app/educator/page.tsx as RSC with auth + educator data fetching
- Created src/components/educator/EducatorDashboard.tsx with:
  - Welcome message displaying educator name
  - 4 MetricCard components: Total Cursos, Cursos Publicados, Total Inscripciones, Próximos Cursos
  - Quick action buttons: Crear Curso, Ver Cursos, Ver Estudiantes (with icons)
  - List of upcoming courses (max 3) with enrollment stats and links
  - Empty state for educators with no courses
- Created src/components/educator/index.ts barrel export

**Technical Notes:**
- Page is a Server Component that fetches data before rendering
- Uses getEducatorByUserId to find educator record from session.user.id
- Uses getEducatorDashboardMetrics to get all dashboard data in single query
- EducatorDashboard is 'use client' to support client-side interactions (Link/Button)
- MetricCard is an internal component for consistent card styling
- Uses shadcn/ui Card and Button components
- Uses lucide-react icons (BookOpen, Users, Calendar, Plus, List, GraduationCap)
- Handles edge cases: no session (redirect to login), no educator record (redirect home)

**Additional fixes:**
- Added p-6 lg:p-8 padding to AppShell main content area (centralized for all authenticated pages)
- Fixed Next.js Image warnings across the app:
  - Logo component: added sizes="144px"
  - Header.tsx: added style={{ width: 'auto', height: 'auto' }} to maintain aspect ratio
  - Footer.tsx: added sizes="192px" to logo Image with fill
  - wset-section.tsx: added sizes="(max-width: 1024px) 100vw, 50vw" to WSET.jpg

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create educator course list page with filters (4.08)

---

## 2026-01-08 - Educator Course List Page (4.08 + 4.10)

**Completed (PRD items 4.08 and 4.10):**
- Updated src/app/educator/courses/page.tsx as RSC with auth + educator data fetching
- Created src/components/educator/CourseList.tsx with:
  - Search input for filtering by title/description
  - Expandable filter panel (same style as landing CourseCatalog)
  - Filter bar: status (Todos, Borrador, Publicado, Finalizado) and type (Todos, WSET, Taller, Cata, Curso)
  - URL query params support (?status=draft&type=wset)
  - Empty states for no courses and no filter results (matching landing style)
  - "Nuevo Curso" button
  - Publish/Unpublish/Delete actions wired to server actions
  - AlertDialog for delete confirmation
  - Toast notifications for success/error
  - Loading state during mutations
- Created src/components/educator/EducatorCourseRow.tsx (list view, not grid):
  - Horizontal row layout matching product-plan design reference
  - Clickable course image (links to edit page)
  - Badges using same styles as landing: type badge (WSET, CATA, etc), modality (Online/Presencial), status (Publicado/Borrador)
  - Title, description (truncated), meta info (alumnos, fecha, duración)
  - Price displayed on right side
  - Dropdown menu with: Editar, Ver estudiantes, Publicar/Despublicar, Eliminar
- Created src/components/educator/EducatorCourseCard.tsx (grid view, kept for potential future use)
- Created src/components/shared/FilterButton.tsx as reusable component
- Created src/components/shared/SearchFilterBar.tsx as reusable component (search + filter button)
- Created src/components/shared/FiltersPanel.tsx as reusable component (configurable filter panel)
- Refactored landing CourseCatalog to use shared SearchFilterBar and FiltersPanel
- Refactored educator CourseList to use shared SearchFilterBar and FiltersPanel
- Both educator and landing now share the same search/filter UI with consistent behavior
- Educator panel now includes tags filter (fetched from getTags service)
- Added shadcn/ui components: Badge, DropdownMenu, AlertDialog

**Technical Notes:**
- List view (EducatorCourseRow) matches product-plan/sections/educator-panel/CourseList.png
- Badges use same colors as landing CourseCard for consistency
- Search is client-side with useMemo for performance
- FilterButton extracted to shared components for reuse
- Page is a Server Component that fetches educator courses before rendering
- Uses useTransition for non-blocking mutations
- Filters applied client-side from URL searchParams for instant feedback
- Delete requires confirmation via AlertDialog to prevent accidental deletion
- Actions call server actions which validate ownership and revalidate paths
- Items 4.08 and 4.10 implemented together since CourseList includes all action wiring

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create presencial course editor form (4.09)

---

## 2026-01-08 - Course Detail Page Tags Display (4.08b)

**Completed (minor enhancement):**
- Added tags display to CourseDetailPage.tsx hero section
- Tags appear below the status badge using verde-uva-500 background (same as landing cards)
- Consistent tag styling across landing cards and course detail page

**Technical Notes:**
- Tags rendered conditionally when course.tags.length > 0
- Uses same visual style as CourseCard tags for UI consistency
- Tags and status badge both displayed in flex-wrap container with gap-2

**Verification:** typecheck ✓, lint ✓, build ✓

**Next Priority:** Create presencial course editor form (4.09)

---
