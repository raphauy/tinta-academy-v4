# Progress - Milestone 05: Admin Panel

## 2026-01-10 - Items 5.01-5.05: Service Layer for Admin Panel

### Completed Items

#### 5.01: Create admin-service for dashboard metrics
- Created `src/services/admin-service.ts`
- Types: DashboardTotals, ChartDataPoint, RecentActivity, TopCourse, DashboardMetrics
- Functions: getDashboardMetrics, getDashboardTotals, getRevenueChart, getEnrollmentsChart, getUserGrowthChart, getRecentActivity, getTopCourses

#### 5.02: Extend student-service with admin functions
- Extended `src/services/student-service.ts`
- Types: StudentWithStats, StudentStats
- Functions: getAllStudentsWithStats, getStudentStats, getStudentByIdWithStats, updateStudentAsAdmin, getStudentsByActivity

#### 5.03: Extend educator-service with admin functions
- Extended `src/services/educator-service.ts`
- Types: EducatorWithStats, EducatorStats, CreateEducatorInput, UpdateEducatorAsAdminInput
- Functions: getAllEducatorsWithStats, getEducatorStats, createEducator, updateEducatorAsAdmin, deleteEducator, promoteUserToEducator, getEducatorByIdWithStats

#### 5.04: Extend user-service with admin functions
- Extended `src/services/user-service.ts`
- Types: UserWithDetails, UserStats, UserActivity
- Functions: getAllUsersWithDetails, getUserStats, updateUserRole, deleteUser, getUserActivity, getVisitors
- Constraints: Cannot demote last superadmin, cannot delete self

#### 5.05: Extend course-service with admin analytics
- Extended `src/services/course-service.ts`
- Types: AdminCourse, CourseObserver, CourseEnrollmentWithDetails, CourseAnalytics
- Functions: getAllCoursesForAdmin, getCourseAnalytics, getCourseObservers (placeholder), getCourseEnrollmentsWithDetails

### Technical Decisions
- Used Prisma aggregations for efficient queries
- Chart functions iterate over months (could be optimized with raw SQL if needed)
- RecentActivity combines multiple entity types and sorts by timestamp
- Revenue calculated from paid orders using finalAmount
- Month formatting uses Spanish locale (es-ES)
- Role constraints handled in updateUserRole and deleteUser
- deleteEducator checks for courses before allowing deletion
- promoteUserToEducator uses transaction to create educator profile and update user role atomically
- CourseObservers is a placeholder - would need a separate model for "interested users" tracking

### Verification
- TypeCheck: PASS
- Lint: PASS (2 pre-existing warnings unrelated to changes)
- Build: PASS

### Next step suggestion
Item 5.06: Create server actions for admin dashboard

## 2026-01-10 - Items 5.06-5.12: Server Actions for Admin Panel

### Completed Items

#### 5.06: Create server actions for admin dashboard
- Created `src/app/admin/actions.ts`
- Helper: requireSuperAdmin() for role verification
- Actions: getDashboardMetricsAction()

#### 5.07: Create server actions for admin courses management
- Created `src/app/admin/courses/actions.ts`
- Actions: getCoursesForAdminAction, getCourseObserversAction, getCourseEnrollmentsAction

#### 5.08: Create server actions for admin students management
- Created `src/app/admin/users/students/actions.ts`
- Actions: getStudentsForAdminAction, getStudentDetailAction, updateStudentAction
- Uses Zod for input validation

#### 5.09: Create server actions for admin educators management
- Created `src/app/admin/users/educators/actions.ts`
- Actions: getEducatorsForAdminAction, getEducatorDetailAction, createEducatorAction, updateEducatorAction, deleteEducatorAction
- Uses promoteUserToEducator for atomic educator creation with role update

#### 5.10: Create server actions for admin users management
- Created `src/app/admin/users/actions.ts`
- Actions: getUsersForAdminAction, updateUserRoleAction, deleteUserAction, getUserActivityAction
- Constraints: cannot demote last superadmin, cannot delete self/change own role

#### 5.11: Create server actions for coupons management
- Created `src/app/admin/coupons/actions.ts`
- Actions: getCouponsForAdminAction, getCouponStatsAction, createCouponAction, updateCouponAction, deleteCouponAction, toggleCouponStatusAction
- CouponWithStats type includes usage count and restricted course info
- Soft delete for coupons with orders

#### 5.12: Create server actions for bank accounts management
- Created `src/app/admin/bank-data/actions.ts`
- Actions: getBankAccountsForAdminAction, createBankAccountAction, updateBankAccountAction, deleteBankAccountAction, toggleBankAccountStatusAction
- Soft delete for accounts referenced by orders

### Technical Decisions
- All actions use requireSuperAdmin() helper for consistent authorization
- ActionResult<T> type pattern for consistent error handling
- Zod validation for all mutation inputs
- revalidatePath() after mutations for cache invalidation
- error.issues for Zod error extraction (TypeScript-compatible)
- Soft delete pattern: deactivate instead of delete when records have dependencies

### Verification
- TypeCheck: PASS
- Lint: PASS (2 pre-existing warnings unrelated to changes)
- Build: PASS

### Next step suggestion
Item 5.13: Create admin UI components - metric cards and charts

## 2026-01-10 - Items 5.13-5.36: Admin Panel UI Components

### Completed Items

#### 5.13: Create metric cards and charts
- Created `src/components/admin/admin-metric-card.tsx`
  - Displays metrics with optional trend indicators
  - Variants: default, primary
  - Dark mode support
- Created `src/components/admin/admin-mini-chart.tsx`
  - Sparkline chart component using SVG
  - Dynamic path calculation from data points
- Created `src/components/admin/activity-feed.tsx`
  - Recent activity list with type-specific icons
  - Activity types: enrollment, payment, user, course
- Created `src/components/admin/top-courses-card.tsx`
  - Top performing courses list
  - Shows enrollments count and revenue

#### 5.14: Create courses section
- Created `src/components/admin/admin-courses.tsx`
  - Course management with search, status filter, sort options
  - Grid layout with cards
  - Empty state handling
- Created `src/components/admin/admin-course-card.tsx`
  - Course card with image, status badge, metrics
  - Actions: view, edit, delete

#### 5.15: Create students section
- Created `src/components/admin/admin-students.tsx`
  - Student listing with search and sort
  - Stats cards: total, new this month, active, completed courses
- Created `src/components/admin/student-row.tsx`
  - Responsive layout (mobile/desktop)
  - Avatar with fallback initials
  - Activity indicator, location, enrollments, spending

#### 5.16: Create educators section
- Created `src/components/admin/admin-educators.tsx`
  - Educator management with search and sort
  - Stats: total educators, courses, students
  - "New Educator" button
- Created `src/components/admin/educator-card.tsx`
  - Profile card with avatar, title, bio
  - Metrics: courses count, students count
  - Actions: view, edit, delete

#### 5.17: Create users section
- Created `src/components/admin/admin-users.tsx`
  - User management with search, role filter, sort
  - Stats: total, new this month, active, role distribution
- Created `src/components/admin/user-row.tsx`
  - Role badges with icons (superadmin, educator, student, user)
  - Registration date, last activity
  - Actions: edit role, delete

#### 5.18: Create orders section
- Created `src/components/admin/admin-orders.tsx`
  - Order management with search, status filter, payment method filter
  - Stats: total orders, pending, paid, total revenue
- Created `src/components/admin/order-row.tsx`
  - Status badges: created, pending_payment, payment_processing, paid, cancelled, refunded, rejected
  - Payment method: mercadopago, bank_transfer, free
  - Coupon indicator, transfer reference tooltip
  - Actions: view details, mark as paid (for pending)

#### 5.19: Create coupons section
- Created `src/components/admin/admin-coupons.tsx`
  - Coupon management with search, status filter (active, inactive, expired, exhausted)
  - Stats: total, active, expired, total uses
  - "New Coupon" button
- Created `src/components/admin/coupon-row.tsx`
  - Status calculation from isActive, expiresAt, currentUses/maxUses
  - Usage progress bar
  - Restrictions display (course, user limits)
  - Actions: edit, toggle active, delete

#### 5.20: Create bank data section
- Created `src/components/admin/admin-bank-data.tsx`
  - Bank account management by currency (USD, UYU)
  - Stats: total accounts, active, by currency
  - "New Account" button
- Created `src/components/admin/bank-account-card.tsx`
  - Account details: bank name, type, holder, number
  - Optional: SWIFT/BIC, routing number, notes
  - Copy-to-clipboard functionality
  - Display order indicator
  - Actions: toggle active, edit, delete

#### 5.21: Create skeleton components
- Created `src/components/admin/admin-skeletons.tsx`
  - AdminDashboardSkeleton
  - AdminCoursesSkeleton
  - AdminStudentsSkeleton
  - AdminEducatorsSkeleton
  - AdminUsersSkeleton
  - AdminOrdersSkeleton
  - AdminCouponsSkeleton
  - AdminBankDataSkeleton

#### 5.30-5.36: Create form dialogs and confirmation dialogs
- Created `src/components/admin/coupon-form-dialog.tsx`
  - Create/edit coupon form with validation
  - Fields: code, description, discount%, max uses, expiration, course restriction
- Created `src/components/admin/bank-account-form-dialog.tsx`
  - Create/edit bank account form
  - Fields: bank name, type, holder, number, currency, SWIFT, routing, notes, order
- Created `src/components/admin/user-role-dialog.tsx`
  - Role selection with descriptions
  - Warning for demotion from superadmin
- Created `src/components/admin/order-detail-dialog.tsx`
  - Complete order information display
  - User, course, payment details, timeline
- Created `src/components/admin/confirmation-dialog.tsx`
  - Generic ConfirmationDialog component
  - Specific: DeleteCouponConfirmDialog, DeleteBankAccountConfirmDialog, MarkOrderAsPaidConfirmDialog

#### Barrel Export
- Created `src/components/admin/index.ts`
  - Exports all admin components for convenient imports

### Technical Decisions
- All components use 'use client' directive
- Brand colors: #143F3B (primary), #6B9B7A (primary dark mode), #99757C (secondary)
- Consistent dark mode support using dark: variants
- Responsive design with mobile-first approach
- renderSortButton pattern instead of inline component definitions (ESLint react-hooks/static-components)
- renderCopyButton pattern for clipboard functionality (same reason)
- useMemo for Date calculations to avoid impure function calls during render
- Skeleton components match layout structure for smooth loading transitions
- Dialog components use shadcn/ui Dialog primitives
- Zod-based form validation where applicable

### Verification
- TypeCheck: PASS
- Lint: PASS (only pre-existing warnings unrelated to admin components)
- Build: PASS

### Next step suggestion
Item 5.22-5.29: Create admin page routes and integrate components

## 2026-01-10 - Item 5.22: Admin Dashboard Page

### Completed Item

#### 5.22: Implement admin dashboard page
- Updated `src/app/admin/page.tsx` as RSC
- Fetches dashboard metrics using getDashboardMetrics from admin-service
- Passes data to AdminDashboard component
- Wraps in Suspense with AdminDashboardSkeleton fallback
- Added metadata: title 'Dashboard - Admin'
- Follows async server component pattern from educator/page.tsx

### Technical Decisions
- Used simple DashboardContent async function pattern (no auth check needed - layout handles it)
- AdminDashboard receives metrics directly from service
- Skeleton provides loading state during data fetch

### Verification
- TypeCheck: PASS
- Lint: PASS (pre-existing warnings only)
- Build: PASS

### Next step suggestion
Item 5.23: Implement admin courses page

## 2026-01-10 - Item 5.23: Admin Courses Page

### Completed Item

#### 5.23: Implement admin courses page
- Updated `src/app/admin/courses/page.tsx` as RSC
- Fetches courses using getAllCoursesForAdmin from course-service
- Created `admin-courses-client.tsx` for client-side navigation handling
- Wraps in Suspense with AdminCoursesSkeleton fallback
- Added metadata: title 'Cursos - Admin'
- onViewDetails navigates to `/educator/courses/[id]/edit`
- onViewEnrollments navigates to `/educator/courses/[id]/students`

### Technical Decisions
- Separated RSC (page.tsx) from client logic (admin-courses-client.tsx)
- Reused educator routes for course viewing/editing (no need for separate admin routes)
- Unified filters between educator and admin courses:
  - Both have: Modalidad, Tipo, Temas, Estado (in that order)
  - Admin has granular status options (all course states)
  - Educator has simplified status (draft, published, finished)
- Refactored to use shared components:
  - SearchFilterBar for search input and filter toggle
  - FiltersPanel for filter controls (extended with statusOptions prop)
  - AdminMetricCard for stats cards
- Filters use query params (?status=draft&modality=online&type=wset)
- FiltersPanel uses 2-column grid layout for 4 filters

### Verification
- TypeCheck: PASS
- Lint: PASS (pre-existing warnings only)
- Build: PASS

### Next step suggestion
Item 5.24: Implement admin students page

## 2026-01-10 - Item 5.24: Admin Students Page

### Completed Item

#### 5.24: Implement admin students page
- Updated `src/app/admin/users/students/page.tsx` as RSC
- Fetches students and stats using getAllStudentsWithStats and getStudentStats from student-service
- Created `admin-students-client.tsx` for client-side modal handling
- Wraps in Suspense with AdminStudentsSkeleton fallback
- Added metadata: title 'Estudiantes - Admin'
- Created `StudentDetailDialog` component for viewing and editing student info
- onView opens modal in view mode, onEdit opens in edit mode
- Calls updateStudentAction on save

### Technical Decisions
- Separated RSC (page.tsx) from client logic (admin-students-client.tsx)
- Created StudentDetailDialog without tabs (tabs component not available) - used simple layout with stats at top and info below
- Dialog supports view/edit modes with toggle button
- Edit form updates firstName, lastName, phone, city, country, identityDocument
- Added StudentDetailDialog export to components/admin/index.ts
- Changed StudentWithStats.totalSpent to totalSpentUSD and totalSpentUYU for accurate currency display
- Updated student-row.tsx to show both currencies when applicable (e.g. "USD 350 / $ 54.580")
- StudentDetailDialog uses Wallet icon instead of DollarSign to avoid confusion with UYU's $ symbol
- Search input and action buttons use shadcn components consistently
- Student name is clickable to open detail dialog

### Verification
- TypeCheck: PASS
- Lint: PASS (pre-existing warnings only)
- Build: PASS

### Next step suggestion
Item 5.25: Implement admin educators page

## 2026-01-10 - Item 5.25: Admin Educators Page

### Completed Item

#### 5.25: Implement admin educators page
- Updated `src/app/admin/users/educators/page.tsx` as RSC
- Fetches educators and stats using getAllEducatorsWithStats and getEducatorStats from educator-service
- Created `admin-educators-client.tsx` for client-side modal handling
- Wraps in Suspense with AdminEducatorsSkeleton fallback
- Added metadata: title 'Educadores - Admin'

### New Components Created
- `src/components/admin/educator-detail-dialog.tsx`:
  - View mode: educator stats (courses, students), email, bio, member since
  - Edit mode: form for name, title, bio, imageUrl
  - Uses same pattern as StudentDetailDialog
- `src/components/admin/create-educator-dialog.tsx`:
  - Select from eligible users (users without educator profile)
  - Pre-fills name from user's name if available
  - Form fields: name, title, bio, imageUrl
  - Shows loading state while fetching eligible users
  - Shows warning when no eligible users available

### Service & Actions Updates
- Added `getEligibleEducatorUsers()` to user-service.ts
  - Returns users without educator profile
- Added `getEligibleEducatorUsersAction()` to educators/actions.ts
  - Fetches eligible users for create educator dialog

### Technical Decisions
- Separated RSC (page.tsx) from client logic (admin-educators-client.tsx)
- Used `ConfirmationDialog` for delete with custom description showing courses count
- Delete dialog shows warning if educator has courses associated
- Create dialog fetches eligible users lazily (on dialog open)
- Updated barrel export in components/admin/index.ts

### Verification
- TypeCheck: PASS
- Lint: PASS (pre-existing warnings only - img elements and react-hook-form watch)
- Build: PASS

### Next step suggestion
Item 5.26: Implement admin users page
